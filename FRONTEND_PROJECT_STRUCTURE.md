# Commission Tracker Admin Panel - Подробная архитектура проекта

Этот документ — исчерпывающее руководство по фронтенд-архитектуре. Он объясняет назначение каждого ключевого компонента, принципы его работы и то, как они взаимодействуют друг с другом.

# Бизнес-презентация возможностей фронтенда

**Commission Tracker Admin Panel** — это не просто сайт. Это профессиональный, интуитивно понятный и быстрый рабочий инструмент, созданный для того, чтобы финансовые консультанты и администраторы могли максимально эффективно управлять своим бизнесом. Он превращает сложную логику нашего мощного бэкенда в простой и удобный пользовательский интерфейс.

---

## Ключевые возможности для пользователя

### 1. Централизованная панель управления ("Командный центр")

-   **Что это дает?** Консультанту (`Adviser`) больше не нужно держать информацию в разных местах. Он входит в систему и сразу видит полную картину: свои активные сделки, последние рассчитанные комиссии и ключевые показатели эффективности.
-   **Как это выглядит?** Главная страница (`Dashboard`) будет содержать интерактивные виджеты и графики, которые наглядно показывают состояние дел.

### 2. Интуитивно понятный рабочий процесс

Мы спроектировали интерфейс так, чтобы он соответствовал реальному рабочему процессу консультанта, делая его работу проще, а не сложнее.

-   **Что это дает?** Минимизация времени на рутинные операции. Создание клиента, открытие новой сделки, изменение ее статуса — все это делается в несколько кликов в едином, логичном интерфейсе.
-   **Как это выглядит?**
    -   **Просмотр данных**: Вся информация представлена в виде четких, сортируемых таблиц (`Ant Design`) с поиском и фильтрацией.
    -   **Создание и редактирование**: Для создания и редактирования используются удобные модальные окна с валидацией форм, что предотвращает ошибки ввода.
    -   **Изменение статуса**: Статус сделки можно изменить прямо из таблицы, выбрав нужное значение из выпадающего списка.

### 3. Адаптивный интерфейс на основе ролей

Система умна и показывает каждому пользователю только то, что ему нужно и разрешено видеть.

-   **Что это дает?** Безопасность и фокус. `Adviser` не отвлекается на чужие данные или административные функции. `Admin` имеет полный контроль над системой из одного места.
-   **Как это выглядит?**
    -   **Для `Adviser`'а**: В меню доступны только его рабочие разделы ("Мои сделки", "Мои клиенты", "Мои комиссии").
    -   **Для `Admin`'а**: В меню появляются дополнительные пункты ("Все сделки", "Пользователи", "Комиссионные планы", "Отчеты").

---

## Техническое совершенство (Почему этот интерфейс "Топ 1")

-   **Скорость и отзывчивость**: Благодаря современному сборщику **Vite** и фреймворку **React**, интерфейс загружается и работает молниеносно. Пользователь не ждет, пока прогрузятся страницы.
-   **Надежность**: Использование **TypeScript** на 100% проекта исключает целый класс ошибок еще на этапе написания кода. **Redux Toolkit** обеспечивает предсказуемое управление состоянием, что делает приложение стабильным.
-   **Профессиональный внешний вид**: Библиотека компонентов **Ant Design** предоставляет нам готовый набор высококачественных, консистентных и эстетически приятных элементов интерфейса, которые являются стандартом для корпоративных и финансовых приложений.
-   **Бесшовная интеграция с бэкендом**: **RTK Query** автоматически обрабатывает загрузку данных, кэширование и обновление. Это означает, что данные на экране всегда актуальны, а интерфейс остается отзывчивым даже во время обмена данными с сервером.

**Итог:** Commission Tracker Admin Panel — это современный, надежный и удобный инструмент, который позволяет пользователям в полной мере раскрыть потенциал нашего мощного бэкенда.

---
---

# Commission Tracker Admin Panel - Подробная архитектура проекта

Этот документ — исчерпывающее руководство по фронтенд-архитектуре. Он объясняет назначение каждого ключевого компонента, принципы его работы и то, как они взаимодействуют друг с другом.

## Технологический стек

- **Фреймворк**: React
- **Язык**: TypeScript
- **Сборщик**: Vite
- **Управление состоянием и данными**: Redux Toolkit (RTK) с RTK Query
- **UI-компоненты**: Ant Design
- **Стилизация**: Tailwind CSS
- **Маршрутизация**: React Router

## Архитектурные принципы

1.  **Feature-Sliced Design (FSD)**: Логика приложения сгруппирована по функциональным модулям ("фичам"), таким как `auth`, `mortgages`, `policies`. Это делает проект масштабируемым и легко поддерживаемым.
2.  **DRY (Don't Repeat Yourself)**: Общая логика и UI вынесены в переиспользуемые компоненты. Яркий пример — `ResourcePage.tsx`.
3.  **Single Source of Truth**: Redux Store является единственным источником состояния для всего приложения.

---

## Структура директорий (`src/`)

### `main.tsx` — Точка входа

Это самый первый файл, который запускается в приложении. Его задача — "обернуть" все приложение в необходимые провайдеры:
-   `<Provider store={store}>`: Подключает Redux, делая "хранилище" (store) доступным во всех компонентах.
-   `<BrowserRouter>`: Включает маршрутизацию (возможность переходить по страницам).

### `App.tsx` — Корневой компонент и маршрутизация

Этот файл отвечает за глобальную структуру и навигацию.
-   Он определяет **публичные** (`/login`) и **защищенные** маршруты.
-   Защищенные маршруты оборачиваются в компонент `<ProtectedRoutes />`, который не пустит неавторизованного пользователя внутрь.
-   Он рендерит основной `Layout` приложения (боковое меню, шапка, подвал).
-   Компонент `<Outlet />` из `react-router-dom` — это "место", куда будут подставляться дочерние страницы (`Dashboard`, `MortgagesPage` и т.д.).

### `types/` — Типы данных

Здесь мы описываем "форму" наших данных с помощью TypeScript.
> **Пример `types/index.ts`:**
> ```typescript
> export interface Mortgage {
>   id: number;
>   name: string;
>   status: string;
>   loan_amount: number;
> }
> ```
> Это помогает избежать опечаток и делает код самодокументируемым.

### `components/` — Переиспользуемые UI-компоненты

Здесь лежат "глупые" (dumb) компоненты, которые не содержат бизнес-логики, а только отображают данные.

-   `ProtectedRoutes.tsx`: Проверяет, есть ли токен в Redux-хранилище. Если да — показывает запрошенную страницу (`<Outlet />`). Если нет — перенаправляет на `/login`.
-   `ResourcePage.tsx`: **Ключевой компонент архитектуры**. Это универсальный компонент для отображения любой таблицы с данными.
    > **Как он работает?** Он принимает в качестве "пропсов" хук для запроса данных (например, `useGetMortgagesQuery`) и конфигурацию колонок. Внутри себя он вызывает этот хук, обрабатывает состояния загрузки и ошибки и рендерит таблицу Ant Design. Это позволяет нам не писать одинаковый код для таблиц ипотек и полисов.

### `services/` — Слой для работы с API

-   `api.ts`: Ядро нашего взаимодействия с бэкендом.
    > `createApi` создает базовый сервис.
    > `fetchBaseQuery` настраивает все запросы:
    > - `baseUrl: '/api/'`: Все запросы будут автоматически отправляться на `/api/...`.
    > - `prepareHeaders`: Эта функция перед **каждым** запросом "заглядывает" в Redux-хранилище, достает оттуда токен и добавляет его в заголовок `Authorization`. Это обеспечивает аутентификацию всех наших API-вызовов.

### `store/` — Хранилище состояния

-   `store.ts`: Настраивает Redux Store. Он объединяет все "слайсы" (reducers) в одно большое дерево состояний.

### `features/` — Бизнес-логика

Это основная логика приложения, разделенная по доменным областям ("фичам").

-   `auth/`: Все, что связано с аутентификацией.
    -   `authSlice.ts`: "Слайс" состояния. Хранит токен аутентификации. Имеет действия `setCredentials` (сохранить токен в state и `localStorage`) и `logOut` (удалить токен).
    -   `authApiSlice.ts`: API-слайс. Определяет `login` mutation (запрос на вход). Когда этот запрос успешно выполняется, мы вызываем `setCredentials` для сохранения токена.

-   `mortgages/` и `policies/`:
    -   `...ApiSlice.ts`: Эти файлы "расширяют" наш базовый API-сервис из `services/api.ts`, добавляя в него конкретные эндпоинты (`getMortgages`, `getPolicies`). RTK Query автоматически генерирует для них хуки (`useGetMortgagesQuery`), которые мы используем на страницах.

### `pages/` — Страницы приложения

Это "умные" (smart) компоненты, которые представляют собой целые страницы.

-   `Login.tsx`: Страница входа. Использует хук `useLoginMutation` для отправки данных формы на бэкенд.
-   `Mortgages.tsx`: Страница со списком ипотек. Использует `ResourcePage` и передает в него `useGetMortgagesQuery`.
-   `Policies.tsx`: Страница со списком полисов. Использует `ResourcePage` и передает в него `useGetPoliciesQuery`.

---

## Бизнес-процессы на фронтенде

Этот раздел объясняет, как фронтенд-архитектура реализует пользовательские сценарии.

### Взаимодействие со сделками (сценарий для `Adviser`)

1.  **Вход в систему**: Пользователь вводит логин/пароль на странице `/login`. Хук `useLoginMutation` отправляет запрос на бэкенд. В случае успеха токен сохраняется в Redux-хранилище, и пользователя перенаправляет на главную панель.
2.  **Просмотр сделок**: `Adviser` переходит на страницу `/mortgages`. Компонент `Mortgages.tsx` вызывает хук `useGetMortgagesQuery`. Этот хук отправляет запрос на `/api/mortgages/`. Бэкенд, благодаря `OwnerViewSetMixin`, автоматически отфильтрует и вернет **только сделки этого `Adviser`'а**.
3.  **Создание сделки**: На странице будет кнопка "Создать сделку". Она откроет модальное окно (компонент `Modal` из Ant Design) с формой. После заполнения и отправки формы будет вызван `mutation`-хук (например, `useCreateMortgageMutation`), который отправит POST-запрос на `/api/mortgages/`. Бэкенд автоматически присвоит `user`'а этой сделке.
4.  **Изменение статуса**: В таблице со сделками у каждой строки будет кнопка или выпадающее меню для изменения статуса. При выборе нового статуса будет вызван `mutation`-хук (например, `useUpdateStatusMutation`), который отправит PATCH-запрос на специальный эндпоинт `/api/mortgages/1/status/`.

### Ограничения по ролям в интерфейсе

Интерфейс будет адаптироваться в зависимости от роли пользователя.

-   **Для `Adviser`'а**: Он видит в меню пункты "Ипотека", "Полисы", "Клиенты". В таблицах он видит только свои данные.
-   **Для `Admin`'а**: Он будет видеть **дополнительные** пункты в меню, например, "Пользователи", "Комиссионные планы", "Отчеты". В таблицах сделок он будет видеть данные **всех** консультантов.

**Как это реализовать?** После логина, вместе с токеном, мы можем запрашивать информацию о профиле пользователя (включая его роль). В зависимости от этой роли мы можем условно рендерить те или иные компоненты.

```jsx
// Пример условного рендеринга
{user.role === 'Admin' && (
  <Menu.Item key="99" icon={<TeamOutlined />}>
    <Link to="/users">Пользователи</Link>
  </Menu.Item>
)}
```

### Просмотр комиссий (будущий функционал)

Будет создана отдельная страница `/commissions`. На ней `Adviser` сможет увидеть таблицу со всеми своими рассчитанными комиссиями (объекты `Commission` с бэкенда). В таблице будут колонки: "Сделка", "Сумма комиссии", "Дата расчета", "Статус выплаты". Также здесь можно будет визуализировать `VestingSchedule` (график выплат) и отслеживать потенциальные `Clawback` (возвраты).
